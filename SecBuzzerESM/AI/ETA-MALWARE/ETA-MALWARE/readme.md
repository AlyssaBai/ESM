# ETA-MAL-NTU

## Prerequest

An `Python3` environment. If you want to run it on docker, recommand using `python:3.8.5-buster`(gcc is needed).

## Install library with pip
You can use `pip3 install` to install packages below

- wheel==0.31.1
- Cython==0.28.2
- elasticsearch==6.3.1
- Flask==1.0.2
- xgboost==1.0.0
- scikit-learn==0.23.1
- pandas==0.25.0
- numpy==1.18.4

or you can use `pip3 install -r requirements.txt`

[NOTE] There may be an error message for build pandas, but it doesn't matter.

## config.ini

Parameters listed below could be changed with requirement.

```
[ES]
es_server = 192.168.70.120
es_port = 9201
```

## Run Code

If you have not ES, you can select csv file to run this code, `-input csv`.
Otherwise, the default of input data is from es.

```
python3 predicting.py [-h] [-input MODE]

optional arguments:
  -h, --help            show this help message and exit
  -input MODE, -mode MODE
                        the source of input data, from csv or es
```

## API Example

Firstly, running code.

```
python3 eta_mal_ntu_api.py
```

Secondly, select https or curl to use.

- API route: eta_mal_ntu/api/v1.0
- API example
	- index
	- start_time
		- format: YYYY-mm-ddTHH:MM:SS.ffffff+08:00
	- end_time
 		- format: YYYY-mm-ddTHH:MM:SS.ffffff+08:00


```
http://localhost:5000/eta_mal_ntu/api/v1.0?index=cic_20200909&start_time=2020-09-09T00:00:00.000000%2B08:00&end_time=2020-09-09T01:00:00.000000%2B08:00
```

```
curl -i http://localhost:5000/eta_mal_ntu/api/v1.0\?index\=cic_20200909\&start_time\=2020-09-09T00:00:00.000000%2B08:00\&end_time\=2020-09-09T01:00:00.00000%2B08:00
```

## Response Code
Code | Description
-----|--------------
200  | Success
404  | Not Found
500  | Internal Server Error

## Input Schema
Below table is an example of input schema from ES.

Key                            | Value
-------------------------------|---------------
Src Port                       | 59175
Dst Port                       | 9201
Protocol                       | 6
Fwd IAT Min                    | 24.0
Fwd IAT Max                    | 25006.0
Fwd IAT Mean                   | 6960.75
Fwd IAT Std                    | 12053.697893869195
Bwd IAT Min                    | 3705.0
Bwd IAT Max                    | 19513.0
Bwd IAT Mean                   | 11609.0
Bwd IAT Std                    | 11177.943996996943
Flow IAT Min                   | 24.0
Flow IAT Max                   | 19513.0
Flow IAT Mean                  | 3977.5714285714284
Flow IAT Std                   | 6941.2158602832405
Flow Bytes/s                   | 107962.50404051288
Flow Packets/s                 | 287.32536005459184
Flow Duration                  | 27843
Total Fwd Packet               | 5
Total Bwd packets              | 3
Fwd BYTES Min                  | 54
Fwd BYTES Max                  | 1514
Fwd BYTES Mean                 | 716.1428571428571
Fwd BYTES Std                  | 751.1059464929983
Bwd BYTES Min                  | 60
Bwd BYTES Max                  | 377
Bwd BYTES Mean                 | 218.5
Bwd BYTES Std                  | 224.15284963613556
Fwd 2 Bwd Total                | 2
Bwd 2 Fwd Total                | 2
Fwd b_p BCD Min                | 66
Fwd b_p BCD Max                | 978
Fwd b_p BCD Mean               | 522
Fwd b_p BCD Std                | 644.8813844421313
Bwd b_p BCD Min                | 66
Bwd b_p BCD Max                | 218
Bwd b_p BCD Mean               | 142
Bwd b_p BCD Std                | 107.48023074035522
Fwd TTL Total                  | 896
Bwd TTL Total                  | 126
Total IP Length of Fwd Packet  | 4915
Total IP Length of Bwd Packet  | 403
Payload BYTE Distribution      | 0-0-0-0-0-0-0-0-0-0-15-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-403-0-14-0-0-0-0-0-0-1-0-0-4-0-32-5-104-32-109-116-68-42-76-42-18-15-19-0-0-1-0-1-0-1-4-2-2-0-1-1-2-2-0-0-2-1-0-1-4-0-0-3-6-0-0-0-0-0-0-0-0-0-0-4-0-13-2-17-17-20-22-1-1-4-0-1-2-2-2-5-1-0-1-0-8-1-1-4-1-0-0-1-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0

## Output Schema
Below table is an example of output schema to ES.

Key                 | Value
--------------------|---------------
flow_id             | XyPZBXEBOI2XA3yCwRPD
timestamp           | 2020-03-23T13:24:39.144408+08:00
event_type          | alert
alert.category      | Dridex
alert.severity      | 2
alert.signature     | CSTI ETA-MAL-NTU - Dridex
src_ip              | 192.168.70.196
dest_ip             | 192.168.70.1
src_port            | 138
dest_port           | 138
alert.action        | N/A
proto               | tcp
module              | ETA-MAL-NTU
in_iface            | [From Input]
alert.signature_id  | 20130001
log_type            | traffic
reference           | 0
log_time            | 2020-03-11T10:02:56.762791+08:00
alert.gid           | 0
dump_status         | 0
ingest_timestamp    | 2020-03-23T05:24:39.144408Z
